---
title: "Applying Spectral Methods To Mizer"
author: "Richard Southwell"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction



In order to evolve the McKendrik-von Foerster equation PDE

\begin{equation}
\frac{\partial N_{i}(w)}{\partial t}=-\frac{\partial\left[g_{i}(w)N_{i}(w)\right]}{\partial t}-\mu_{i}N_{i}(w)
\end{equation}

We also include an extra boundary condition about new fish (eggs) of size $w_0$ appearing over time due to evolution, but we shall get into that later.


The point is that the above PDE (Equation 1) describes the time evolution of the individual-density function, $N_i(w),$ which is such that $N_i(w) dw$ equals the number of individuals with a weight in the interval $[w, w+dw],$  when $dx$ is small.

We can evolve this PDE numerically by repeatedly evaluating the right hand side of the PDE and then using this information into integrate-forward/project $\frac{\partial N_{i}(w)}{\partial t}$. This can be done by repeatedly evaluating the right hand side of the PDE, and then applying some method, such as the Euler method, or the method of lines), to approximate the time evolution of $N_{i}(w).$  

Since we have to evaluate the right hand side of Equation (1) many times in order to evolve our PDE, it is important to be able to do it quickly. The most time consuming parts of evaluating the right hand side of our PDE at a given time involve evaluating growth rate $g_{i}(w)$ and mortality rate $\mu_{i}N_{i}(w)$. 

The central point of this document is that we have implemented ways of evaluating the integrals of which $g_{i}(w)$ and $\mu_{i}N_{i}(w)$ are comprised, using spectral methods, which can evaluate the integrals many orders of magnitude faster. This is possible because the integrals in question are convolution integrals, and they can be evaluated quickly using the fast Fourier transform (fft).

## The Integrals we want to evaluate faster

The growth rate $g_i(w)$ involves many terms concerning search rates, feeding levels, partitions of energy into growth, reproduction and metabolism, but the computation bottleneck in evaluating the growth rate, at a particular time, is the determination of the available energy:

\begin{equation}
E_{a.i}(w)=\int_{0}^{\infty}\left(N_{R}\left(w_{p}\right)+\sum_{j=1}^{s}\theta_{i,j}N_{j}(w_{p})\right)\Phi_{i}\left(\frac{w_{p}}{w}\right)w_{p}dw_{p}
\end{equation}

is the amount of available food that predator $w$ could get, over all species, resources, and prey masses.

The mortality rate $\mu_{i}(w)$ of a fish of mass $w$ equals 

$$\mu_{i}(w) = \mu_{p.i}(w) + \mu_{s.i}(w) + \mu_{b.i}(w) + \mu_{f.i}(w),$$
where $\mu_{p.i}(w)$ is the predation mortality, and $\mu_{s.i}(w)$ is the starvation mortality, and $\mu_{b.i}(w)$ is the background mortality, and $\mu_{f.i}(w)$ is the fishing mortality. The computational bottleneck to determining the predation mortality. Thankfully this can be done quickly by exploiting the convolution integrals within $\mu_{p.i}(w),$ as we describe in our section on `Mortality Integral And Spectral Methods'.
 

## Writing Available Energy As A Convolution Integral

We can rewrite our integral for the available energy as 

\[
E_{a.i}(w)=\int_{0}^{\infty}Q(w_{p})\Phi_{i}\left(\frac{w_{p}}{w}\right)dw_{p}
\]

where $Q(w_{p})=\left(N_{R}\left(w_{p}\right)+\sum_{j=1}^{s}\theta_{i,j}N_{j}(w_{p})\right)w_{p}$
measures the energy that prey $w$ gets from eating different fish
and plankton of size $w_{p}.$ 

Let us transform the available energy integral into `x-space', by
making the substitutions

$x=\frac{\log(w)}{log(w_{0})}$ and $y=\frac{\log(w_{p})}{log(w_{0})},$
so we have $w=w_{0}e^{x}$ and $w_{p}=w_{0}e^{y}$ and $dw_{p}=w_{p}.dy$,
we can rewrite our expression for available energy as 

\[
E'_{a.i}(x):=E_{a.i}(w)=E_{a.i}(w_{0}e^{x})=\int_{-\infty}^{\infty}Q(w_{0}e^{y})\Phi_{i}\left(\frac{w_{0}e^{y}}{w_{0}e^{x}}\right)w_{0}e^{y}.dy
\]

So $E'_{a.i}(x)$ available energy $E_{a.i}(w)$ to a prey of mass
$w=w_{0}e^{x},$ 

\[
E'_{a.i}(x)=\int_{-\infty}^{\infty}Q(w_{0}e^{y})\Phi_{i}\left(e^{y-x}\right)w_{0}e^{y}.dy
\]

If we define $q(y)=Q(w_{0}e^{y})w_{0}e^{y},$ and we recall, $\phi_{i}\left(y-x\right)=\Phi_{i}\left(e^{y-x}\right),$
as described in section {*}, we see that $E'_{a.i}(x)$ can be rewritten
as 

\[
E'_{a.i}(x)=\int_{-\infty}^{\infty}q(y)\phi_{i}(y-x)dy
\]

This is a convolution integral, accessible to spectral methods, however
to make things more clear, let us perform the substitution $y'=x-y,$
so we rewrite $E'_{a.i}(x)$ as 

\[
E'_{a.i}(x)=\int_{-\infty}^{\infty}q(x-y')\phi_{i}(-y')dy',
\]
to see how spectral methods can be applied to this issue more easily
we can define the function $\psi_{i}(v)$ such that for every real
$v$ we have 

$\psi_{i}(v):=\phi_{i}(-v)=\exp\left[\frac{-\left(v-\beta_{i}\right)^{2}}{2\sigma_{i}^{2}}\right]$,
so now we can rewrite $E'_{a.i}(x)$ as 

\[
E'_{a.i}(x)=\int_{-\infty}^{\infty}q(x-y')\psi_{i}(y')dy',
\]

moreover, since $\psi_{i}(y')$ is a Gaussian, which is heavily concentrated
about $\beta_{j},$ with $\psi_{i}(y')$ becoming very small when
$\left|y'-\beta_{i}\right|>5\sigma_{i},$ it makes sense that artificially
truncate our Gaussian $\psi_{i}(y')$, by supposing the support of $\psi$,  that is, $\left\{ y':\psi_{i}(y')\neq0\right\}$
is contained in some interval $\sup(\psi_{i})=[L_{\psi},R_{\psi}]\ni\beta_{i},$
for example we could have $L_{\psi}=\beta_{i}-5\sigma_{i}$ and $R_{\psi}=\beta_{i}+5\sigma_{i}$.
Now we know $s$ has limited support we can write our integral as

\[
E'_{a.i}(x)=\int_{L_{\psi}}^{R_{\psi}}q(x-y')\psi_{i}(y')dy',
\]

We want to evaluate this integral for each $x\in[0,X_{i}]$, and this
can be done using fast Fourier transform based spectral integration.


## About the feeding Kernel


Let $\{1,..,s\}$ denote the set of species.

The feeding Kernel $\Phi _i$ measures amount of preference that a predator has weight $W_p$ has for a prey of weight $w$ is 

$$\Phi _i \left( \frac{w_p}{w} \right) = \exp \left[ \frac{-\left(\ln \left( \frac{w}{w_p} \right) - \ln(\beta _i ^*) \right)^2}{2\sigma_i ^2} \right].$$
We shall normalize mass by dividing by the egg size $w_0,$ and logs, to re-represent this information in the `x-space' where $x=\frac{\log(w)}{log(w_{0})},$ and $y=\frac{\log(w_p)}{log(w_{0})}.$ Before we consider the feeding kernel in these terms, let us note, that for any real number $v$ we have:

$$\Phi_{i}\left(e^{v}\right)=\exp\left[\frac{-\left(\ln\left(e^{-v}\right)-\ln(\beta_{i}^{*})\right)^{2}}{2\sigma_{i}^{2}}\right]=\exp\left[\frac{-\left(v+\beta_{i}\right)^{2}}{2\sigma_{i}^{2}}\right],
$$
where $\beta_i = \ln(\beta_i ^*),$ and $\Phi_{i}\left(e^{v}\right)$ is concentrated about $-\beta_i.$

Let us return to consideration of $\Phi _i \left( \frac{w_p}{w} \right).$ By making our substitutions, we can rewrite $Phi_i$ in terms of $x$ and $y$ as

$$\Phi_{i}\left(\frac{w_{p}}{w}\right)	=	\Phi_{i}\left(\frac{w_{0}e^{y}}{w_{0}e^{x}}\right)=\Phi_{i}(e^{y-x})=\exp\left[\frac{-\left(y-x+\beta_{i}\right)^{2}}{2\sigma_{i}^{2}}\right]$$

To illustrate, let us consider a practical example where the width of the feeding distribution is $\sigma_i = 1,$ the (log-space) predator size is $x=8$, and the log of the preferred predator-prey mass ratio is $\beta_i = \ln(\beta _i ^* ) = 3.$ 

Below we plot the resulting feeding kernel, the horizontal axis gives the (log-space) prey size, and the vertical axis measures the amount of preference that our size $x=8$ predators have for this prey:


```{r}
sigma <- 1
x <- 8
beta <- 3
dy <- 0.1
y <- seq(0, 10, by = dy)
Preference_x_has_for_prey_y <- exp((-((y-x+beta)^2))/(2*sigma^2))
plot(y,Preference_x_has_for_prey_y)
```
Because the size of the predator is $x=8,$ its most preferred prey size is 
$$x - \beta_i = 8-3$$, which is the $y$ value at which the feeding preference function plotted above is concentrated at.   

mass ratios, 

Next: add x and y in, and make plot

and 
 

The predation mortality
for a species $i$, with a size $w$ such that

\[
x=\frac{\log(w)}{log(w_{0})}
\]

In the $x$ space we want to evaluate the $\mu_{P,i}(x),$, $\forall x\in[x_{0},X_{i}]$,
where $w_{0}$ is the fish size, and $X_{i}$ is the maximal size/
biomass of species $i\in{1,..,s},$ and $s$ is the number of species.

\[
\ensuremath{\mu_{P,i}(x)=\sum_{j=1}^{s}\int_{-\infty}^{\infty}\phi_{j}(y)q_{j,i}(x-y)dy}
\]

We can rewrite this expression as $\ensuremath{\mu_{P,i}(x)=\sum_{j=1}^{s}\mathbb{I}_{j,i}(x),}$where
$\mathbb{I}_{j,i}(x)=\int_{-\infty}^{\infty}\phi_{j}(y)q_{j,i}(x-y).$
Here $supp(q_{j,i})=[x_{0},X_{j}]=[0,X_{j}],$ and 



*****************************


* * * * *

## Truncated gaussian feeding kernel from mizer


We define our truncated Gaussian feeding kernel $\phi_{j}(v)$ such
that $\forall v\in\mathbb{R}$ we have 

\[
\Phi_j(e^v)= \phi_{j}(v)=\begin{cases}
\exp\left(\frac{-(v+\beta_{j})^{2}}{2\sigma_{j}^{2}}\right) & \text{if \ensuremath{v\in[-\beta_{j}-3\sigma_{j},0]}}\\
0 & \text{otherwise}
\end{cases}
\]

denotes the feeding kernel. Although in practice $\phi_{j}(v)$ is a truncated Gaussian, concentrated at
$-\beta_{j}.$ Naturally $\phi_{j}(v)\rightarrow0$ as $v\rightarrow-\beta_{j}-3\sigma_{j},$
but we also artificially the feeding kernel in mizer so that $v\geq\phi_{j}(v)\Rightarrow\phi_{j}(v)=0,$to
represent how predators will not eat prey larger than themselves.

## Mortality Integral And Spectral Methods


In order to determine $\ensuremath{\mu_{P,i}(x)=\sum_{j=1}^{s}\mathbb{I}_{j,i}(x),}$
we wish to evaluate each 

\[
\mathbb{I}_{j,i}(x)=\int_{-\infty}^{\infty}\phi_{j}(y)q_{j,i}(x-y).dy=\int_{-\beta_{j}-3\sigma_{j}}^{0}\phi_{j}(y)q_{j,i}(x-y).dy
\]

$\forall x\in[x_{0},X_{i}]=[0,X_{j}]$

where $supp(q_{j,i})=[x_{0},X_{j}]=[0,X_{j}]$

We can do this directly, using spectral methods. 

In this integral, we gave that $q_{j,i}(v)$ is used $\forall v=x-y\in[0,X_{i}+\beta_{j}+3\sigma_{j}].$
This means it makes treat $\mathbb{I}_{j,i}(x)$ is a convolution
integral, with period 

\[
P_{i,j}=length\left([-\beta_{j}-3\sigma_{j},0]\right)+length\left([0,X_{i}]\right)=X_{i}+\beta_{j}+3\sigma_{j}=P_{j,i}
\]

Suppose $\bar{\phi_{j}}(v)$ is the periodic extension of $\phi_{j}(v)$
that agrees with $\phi_{j}(v),$ for all $v\in[-\beta_{j}-3\sigma_{j},-\beta_{j}-3\sigma_{j}+P_{j,i}].$

Suppose $\overline{q_{j,i}(v)}$ is the periodic extension of $q_{j,i}(v)$
that agrees with $q_{j,i}(v),$ $\forall v\in[0,X_{i}+\beta_{j}+3\sigma_{j}]=[0,P].$

We can find the appropriate data to input into our spectral integration
method by noting that $v\in[0,P_{j,i}]\Rightarrow\overline{q_{j,i}(v)}=q_{j,i}(v)$
and 

Note that $\forall v\in[0.P]\Rightarrow\bar{\phi_{j}}(v)=\phi_{j}(v-P),$
and now we can evaluate

\[
\mathbb{I}_{j,i}(x)=\int_{-\beta_{j}-3\sigma_{j}}^{0}\phi_{j}(y)q_{j,i}(x-y).dy
\]

\[
\mathbb{I}_{j,i}(x)=\int_{-\beta_{j}-3\sigma_{j}}^{-\beta_{j}-3\sigma_{j}+P_{j,i}}\bar{\phi_{j}}(v)\overline{q_{j,i}(v)}.dy
\]

\[
\mathbb{I}_{j,i}(x)=\int_{-\beta_{j}-3\sigma_{j}}^{-\beta_{j}-3\sigma_{j}+P_{j,i}}\phi_{j}(v-P)q_{j,i}(x-y).dy
\]

\[
\mathbb{I}_{j,i}(x)=\int_{0}^{P_{j,i}}\phi_{j}(v-P)q_{j,i}(x-y).dy
\]


## Notes on supports on feeding kernels

In mizer the feeding kernel$\phi_{i}(v)=\Phi_{i}\left(e^{v}\right)=\exp\left[\frac{-\left(v+\beta\right)^{2}}{2\sigma_{i}^{2}}\right]$
is essentially truncated, as so in mizer we can view it as having
support $sup(\phi_{i})=[-\beta_{i}-3\sigma_{i},0].$ The function
$\phi_{i}(v)$ is essentially the gaussian that appears in the integral
in the predation mortality inegrals (as parts of $\mu_{p.i}(w)$ the
convolution integrals. There is also the gaussian $\psi_{i}(v)=\phi_{i}(-v)=\exp\left[\frac{-\left(v-\beta\right)^{2}}{2\sigma_{i}^{2}}\right],$
which is used in the computation of available energy $E_{a.i}.$ When
using this gaussian, within convolution integrals in mizer, perhaps
it is best to consider it as having support $sup(s_{i})=[0,\beta_{i}+3\sigma_{i}].$


## Differences in notation

In the mizer vignette they write $\beta_i$. I write $\beta _i ^*$ to mean the same thing.

In the mizer vignette they write $\phi_i$. I write $\Phi _i$ to mean the same thing.





